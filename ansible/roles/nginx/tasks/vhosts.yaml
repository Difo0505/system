- name: Setup config dir for vhost
  file:
    path: "{{ nginx_vhosts_dir }}"
    owner: nginx
    group: nginx
    mode: 0750
    state: directory

- name: Setup log dir for vhost
  file:
    path: "{{ item.log_dir }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: 0750
    state: directory
  with_items: "{{ nginx_vhosts }}"

- name: Setup root dir for vhost
  file:
    path: "{{ item.root }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode : 0750
    state: directory
  with_items: "{{ nginx_vhosts }}"
  when: ngx_role == "web"

- name: Ensure all are nginx:nginx
  command: chown -R {{ nginx_user }}:{{ nginx_group }} {{ item.root }}
  with_items: "{{ nginx_vhosts }}"
  when: ngx_role == "web"

- name: Ensure dictories are 0755
  command: find {{ item.root }} -type d -exec chmod 0755 {} \;
  with_items: "{{ nginx_vhosts }}"
  when: ngx_role == "web"

- name: Ensure files are 0644
  command: find {{ item.root }} -type f -exec chmod 0644 {} \;
  with_items: "{{ nginx_vhosts }}"
  when: ngx_role == "web"

- name: Setup config for vhost
  template:
    src: nginx.vhosts.conf.j2
    dest: "{{ nginx_vhosts_dir }}/{{ item.name }}.conf"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: 0640
  with_items: "{{ nginx_vhosts }}"
  tags: vhost_conf

- name: Change user of php-fpm socket to nginx
  lineinfile:
    dest: /etc/php-fpm.d/www.conf
    state: present
    regexp: '^user = '
    line: 'user = {{ nginx_user }}'
  when:
    - ngx_enable_php == 1

- name: Change group of php-fpm socket to nginx
  lineinfile:
    dest: /etc/php-fpm.d/www.conf
    state: present
    regexp: '^group = '
    line: 'group = {{ nginx_group }}'
  when:
    - ngx_enable_php == 1

- name: Change listen owner of php-fpm socket to nginx
  lineinfile:
    dest: /etc/php-fpm.d/www.conf
    state: present
    regexp: '^listen.owner = '
    line: 'listen.owner = {{ nginx_user }}'
  when:
    - ngx_enable_php == 1

- name: Change listen group of php-fpm socket to nginx
  lineinfile:
    dest: /etc/php-fpm.d/www.conf
    state: present
    regexp: '^listen.group = '
    line: 'listen.group = {{ nginx_group }}'
  when:
    - ngx_enable_php == 1

- name: Restart and enable php-fpm
  systemd: name=php-fpm.service enabled=yes daemon_reload=yes state=restarted
  when:
    - ngx_enable_php == 1
    - ansible_distribution == "{{ distro_centos.name }}"
    - ansible_distribution_major_version == "{{ distro_centos.version7 }}"
